= Руководство пользователя
:author: Andrew Tar
:stylesdir: css
:stylesheet: default.css
:experimental:
:icons: font
:imagesdir: docs/readme_images
:toc: auto
:toc-title: Содержание
:figure-caption: Рисунок
:sectnums:
:nofooter:
:noheader:

Перейти к использованию -- <<Usage,Usage>>.

== Что программа делает?

* Дублирует исходный файл, т.е. сохраняет его в неизменном виде;
* Добавляет и удаляет рамки страницы;
* Добавляет несколько стилей текста;
* Устанавливает необходимые отступы страницы;
* Удаляет текущие колонтитулы;
* Добавляет таблицы вне текста в колонтитулах;
* Заполняет таблицы значениями, которые можно извлечь из документа;
* Устанавливает форматирование смежных страниц по выбору пользователя;
* Добавляет логотип ООО "ПРОТЕЙ НТЦ" или ООО "ПРОТЕЙ СпецТехника" на основе децимального номера.

Имя нового файла -- *_<имя исходного файла>_арх.docx_*, *_<имя исходного файла>_тпг.docx_* или *_<имя исходного файла>_прг.docx_*, который расположен в той же директории, что и исходный.

NOTE: Если такой файл уже существует, то к названию будут добавляться постфиксы *__new_*, пока не найдется незанятое имя.

Например, исходный файл называется *_source_file.docx_*, в той же директории лежит файл *_source_file_арх.docx_*.
Тогда при создании архивной версии ей будет присвоено имя *_source_file_арх_new.docx_*.

[IMPORTANT]
Допускается выбор нескольких файлов для обработки.
Однако итоговый формат будет одинаковым для всех.

== Чего программа не делает?

* Не меняет и не обновляет содержимое;
* Не проверяет корректность значений свойств документа, т.е. они добавляются "как есть";
* Не меняет глобальные свойства документа, кроме указанных выше: автор, даты создания/изменения, ...;
* Не проверяет корректность разбиения документа на секции, оставляя на совести автора документа.

== Требования к файлу

* Наличие прав на создание и изменение файлов в директории с исходным файлом;
* Корректное разбиение документа на секции:
** В конце титульной страницы находится разрыв секции;
** После содержания находится разрыв секции;
* Документ должен содержать свойства, в именах которых присутствуют или отсутствуют определенные буквосочетания.
+
****
Порядок сочетаний неважен. +
Регистр неважен. +
Плюсами указаны те, которые должны быть в названии. +
Минусами указаны те, которых быть не должно.
****

[[properties]]
.Требуемые свойства документа, задаваемые пользователем
[horizontal]
Название продукта:: + Doc + Name
Название вида документа:: + Doc + Type - Short
[[decimal-number]]Децимальный номер:: + Dec + Num
Краткое название вида документа:: + Doc + Type + Short

== Добавление логотипа

Децимальный номер определяется на основе <<properties,свойств документа>>, в частности, <<decimal-number>>.

* Если номер начинается с *_ПАМР_*, то используется логотип ООО{nbsp}"НТЦ{nbsp}ПРОТЕЙ";
* Если номер начинается с *_ПДРА_*, то используется логотип ООО{nbsp}"ПРОТЕЙ{nbsp}СпецТехника";
* Если ни одно из буквосочетаний не найдено в начале номера, то используется логотип ООО{nbsp}"ПРОТЕЙ{nbsp}СпецТехника" как логотип по умолчанию. +
При этом добавляется предупреждение `"Не удалось распознать децимальный номер, поэтому используется логотип ПРОТЕЙ СТ по умолчанию"`;
* Если такое свойство не задано в документе, то используется логотип ООО{nbsp}"ПРОТЕЙ{nbsp}СпецТехника" как логотип по умолчанию. +
При этом добавляется предупреждение `"Не задан децимальный номер, поэтому используется логотип ПРОТЕЙ СТ по умолчанию"`.

== Загрузка

Используемый файл зависит от платформы, на которой планируется запуск:

* Windows:
** Классический вид (16+ Мб): https://gitlab.com/tech_writers_protei/docx_modify/-/blob/main/bin/docx_modify.exe[docx_modify.exe];
** Улучшенный вид: (52+ Мб): https://gitlab.com/tech_writers_protei/docx_modify/-/blob/main/bin/docx_modify_ui.exe[docx_modify_ui.exe].
* Linux/MacOS/*nix:
** Классический вид (16+ Мб): https://gitlab.com/tech_writers_protei/docx_modify/-/blob/main/bin/docx_modify[docx_modify];
** Улучшенный вид: (42+ Мб): https://gitlab.com/tech_writers_protei/docx_modify/-/blob/main/bin/docx_modify_ui[docx_modify_ui].

[[Usage]]
== Использование

Пошаговый алгоритм:

. Загрузить исполняемый файл:
* *_docx_modify(_ui).exe_* -- GUI для Windows;
* *_docx_modify(_ui)_* -- GUI для ++*++nix-подобных систем.
+
Файлы находятся здесь:
https://gitlab.com/tech_writers_protei/docx_modify/-/tree/main/bin/[Gitlab repo].
+
. Запустить исполняемый файл.
+
Возможные способы см. <<launch,Запуск программы>>.
+
При запуске файл вызывает консольное окно, в котором вкратце продублировано описание.
На любом этапе по нажатии на кнопку btn:[Отмена] или клавишу kbd:[Esc] работа прекращается.
Далее по нажатии на kbd:[Enter] консольное окно через 1 секунду закроется.
+
[start=3]
. В окне выбрать файлы для изменения.
+
Можно выбрать несколько файлов.
При этом все не +*+.docx-/+*+.docm-файлы будут автоматически отфильтрованы и недоступны для выбора.
+
.Выбор файлов Windows
image::selecting_files_filedialog_win.png[width=562]
+
.Выбор файлов ++*++nix
image::selecting_files_filedialog_mac.png[width=562]
+
. В окне выбрать:
* Вид документа: архивный, типографский или программный;
+
.Меню выбора Windows
image::win_default.png[width=562]
+
.Меню выбора ++*++nix
image::mac_default.png[width=562]
+
[NOTE]
При выборе типографского варианта все последующие опции недоступны.
При выборе программного варианта опция форматирования для Министерства обороны РФ недоступна.
+
.Архивный формат Windows
image::win_arch.png[width=562]
+
.Архивный формат ++*++nix
image::mac_arch.png[width=562]
+
.Типографский формат Windows
image::win_typo.png[width=562]
+
.Типографский формат ++*++nix
image::mac_typo.png[width=562]
+
.Программный формат Windows
image::win_prog.png[width=562]
+
.Программный формат ++*++nix
image::mac_prog.png[width=562]
+
* Тип форматирования страниц: для односторонней или двусторонней печати;
* Используется ли документ для поставок по заказу Министерства Обороны РФ;
* Требуется ли добавить страницу с листом изменений в конец документа;
* Требуется ли добавить информацию о Листе утверждения на титульную страницу.
+
. Посмотреть в вывод программы на наличие предупреждений или ошибок.
+
.Пример вывода
[%collapsible]
====

[source,console,subs="macros+"]
----
pass:[<span class="green">========================================
Версия: 1.4.1
Запуск программы:</span>]
-------------------------------------------------------------------------------
В любом из окон:

* Для подтверждения выбора нажмите кнопку Ok.
* Для прекращения работы скрипта нажмите кнопку Отмена, Закрыть в верхнем углу меню или клавишу <Esc>.

Краткий алгоритм:

1. В открывшемся окне выберите файлы, которые необходимо изменить.

** Можно указать сразу несколько файлов. **

2. В открывшемся окне укажите вид файла: архивный (с рамкой по ГОСТ), типографский или программный.

В архивном виде к файлу добавляется рамка, установленная ГОСТ.
В типографском виде в файле присутствуют только верхние и нижние колонтитулы.
В программном виде к файлу добавляются номер страницы и децимальный номер в верхний колонтитул и таблицу изменений снизу.

3. Если вид архивный или программный, то укажите форматирование файлов: для односторонней или двусторонней печати.

При форматировании для двусторонней печати рамки на обеих сторонах листа совпадают.
При форматировании для односторонней печати рамки на всех страницах имеют одинаковые отступы.

4. Если вид архивный, то выберите, нужно ли оформление привести к требованиям МО РФ.

При активации к нижней рамке на 2 листе добавляются дополнительные ячейки.

5. Если вид архивный или программный, то выберите, нужно ли добавить Лист регистрации изменений в конец документа.

При активации в документ вставляется таблица для Листа регистрации изменений вместе с заголовком.

6. Если вид архивный или программный, то выберите, нужно ли добавить информацию о Листе утверждения на титульную страницу.

При активации в верхний колонтитул добавляются строки:

УТВЕРЖДЕН
<Децимальный номер><Сокращение типа документа>-ЛУ

В терминах свойств документа:

УТВЕРЖДЕН
{DOCPROPERTY _DecimalNum_}{DOCPROPERTY _DocTypeShort_}-ЛУ

7. По завершении работы программы нажмите клавишу <Enter>, чтобы закрыть панель.

8. В обработанном документе обновите все поля со значением "ОБНОВИТЬ".

9. В обработанном документе заполните необходимые пустые поля.
-------------------------------------------------------------------------------
pass:[<span class="magenta">Предупреждение: Проверка имени арх_new ...</span>]
pass:[<span class="green">Имя ПДРА.465929.003ПС(ОТС)_типография_арх_new.docx доступно
Разархивирован файл /Users/andrewtarasov/Desktop/ПДРА.465929.003ПС(ОТС)_типография.docx
Удалены старые колонтитулы</span>]
pass:[<span class="magenta">Предупреждение: Не удалось распознать децимальный номер, поэтому используется логотип ПРОТЕЙ СТ по умолчанию
Предупреждение: DocProperty _DocName_ не найдено в документе
Предупреждение: DocProperty _DocType_ не найдено в документе
Предупреждение: DocProperty _DecimalNum_ не найдено в документе
Предупреждение: DocProperty _DocTypeShort_ не найдено в документе</span>]
pass:[<span class="green">Определены пользовательские свойства документа
Добавлены новые колонтитулы
Добавлен логотип
Нижний колонтитул изменен для поставки МО РФ
Обновлен файл [Content_Types\].xml
Изменены параметры файла
Добавлены новые стили
Изменены внутренние ссылки
Изменены секции в файле
Добавлен лист регистрации изменений
Формула для подсчета страниц добавлена
Информация про Лист утверждения добавлена
Файл сохранен

Обработка файла "/Users/andrewtarasov/Desktop/ПДРА.465929.003ПС(ОТС)_типография.docx" завершена
Новый файл: /Users/andrewtarasov/Desktop/ПДРА.465929.003ПС(ОТС)_типография_арх_new.docx
-------------------------------------------------------------------------------
</span>]
----
====
. По окончании работы нажать btn:[Enter] для закрытия консоли.
+
[source,console]
----
Нажмите <Enter>, чтобы закрыть окно ...
----
+
На окончание указывают сообщения о завершении обработки для каждого файла.
+
[source,console]
----
Обработка файла "/path/to/file.docx" завершена.
----
+
. Открыть новый файл с именем *_<имя исходного файла>_тпг.docx_*, *_<имя исходного файла>_арх.docx_* или *_<имя исходного файла>_прг.docx_* в директории с исходным файлом.
. Обновить все поля внутри всех колонтитулов btn:[Shift] + btn:[F9] со значением *_ОБНОВИТЬ_*.
. Проверить корректность значений.
. Заполнить пустующие поля.

== Версия UI

Версия docx_modify_ui.exe/docx_modify_ui:

* Функциональные возможности совпадают с таковыми в основной версии;
* Имеет более современный интерфейс: базируется на ,библиотеке Qt, в частности, PySide6, в отличие от Tkinter в основной версии;
* Имеет больший размер, поскольку имеет большее количество зависимостей.

.Меню выбора Windows
image::win_default_ui.png[width=562]

.Меню выбора ++*++nix
image::mac_default_ui.png[width=562]

WARNING: Поддерживаются и обновляются обе версии параллельно, однако в первую очередь меняется основная версия

== Возможные проблемы

* <<python-version,"Версия Python должна быть не менее 3.8">>
* <<runtime,"Ошибка обработки файла <File>">>
* <<permission,"Недостаточно прав для изменения файла <File>">>
* <<file-not-found,"Не найден файл <File>">>
* <<rename,"Файл <OldFile> не может быть переименован в <NewFile>">>
* <<os-error,OSError>>
* <<custom,"Файл <file> не найден, поскольку не задано ни одно DocProperty">>
* <<rel-type,"Неизвестное значение RelationshipType <RelType>">>
* <<file-exists,"Файл <File> уже существует">>
* <<docproperty,"DocProperty <DocProperty> не найдено в документе">>
* <<invalid-decimal-num,"Не удалось распознать децимальный номер, поэтому используется логотип ПРОТЕЙ СТ по умолчанию">>
* <<missing-decimal-num,"Не задан децимальный номер, поэтому используется логотип ПРОТЕЙ СТ по умолчанию">>

[[python-version]]
=== "Версия Python должна быть не менее 3.8"

Ошибка означает, что установленная версия Python слишком устаревшая и не поддерживает часть необходимых функций.

Решение: Обновить Python или сменить текущий интерпретатор.

[[runtime]]
=== "Ошибка обработки файла <File>"

Ошибка означает, что внутренняя логика программы попала в бесконечный цикл.

Решение: Сообщить о данной ошибке и по возможности передать лог-файлы и директорию с разархивированным Word-файлом.

[NOTE]
--
В случае завершения работы с ошибкой крайне желательно сохранить директории
*__++_docx_logs/++__* и *__++_docx_temp/++__* на рабочем столе при их наличии.
Это значительно упростит поиск места и причин некорректного поведения скрипта.
--

[[permission]]
=== "Недостаточно прав для изменения файла <File>"

Ошибка означает, что текущий пользователь не имеет права для изменения или копирования файла, или файл нельзя изменять.

Решение: Сменить пользователя или изменить права доступа для файла.

[[file-not-found]]
=== "Не найден файл <File>"

Ошибка означает, что указанный файл был удален или перемещен во время работы программы.

Решение: Повторно запустить скрипт.

[[rename]]
=== "Файл <OldFile> не может быть переименован в <NewFile>"

Ошибка означает, что текущий пользователь не имеет права для изменения или копирования файла, или файл нельзя изменять.

Решение: Сменить пользователя или изменить права доступа для файла.

[[os-error]]
=== OSError

Ошибка означает, что внутренняя логика программы выполнена некорректно, поэтому завершила свою работу нештатно

Решение: Сообщить о данной ошибке и по возможности передать лог-файлы и директорию с разархивированным Word-файлом.

[NOTE]
--
В случае завершения работы с ошибкой крайне желательно сохранить директории
*__++_docx_logs/++__* и *__++_docx_temp/++__* на рабочем столе при их наличии.
Это значительно упростит поиск места и причин некорректного поведения скрипта.
--

[[custom]]
=== "Файл <file> не найден, поскольку не задано ни одно DocProperty"

Предупреждение означает, что для файла не заданы пользовательские свойства документа.

Решение: Задать необходимые свойства документа, указанные в разделе <<properties,Требования к файлу>>.

[[rel-type]]
=== "Неизвестное значение RelationshipType <RelType>"

Предупреждение означает, что в файле обнаружен неизвестный тип Relationship.

Решение: Проигнорировать оповещение, поскольку это никак не влияет на работу программы для конечного пользователя.
По возможности передать информацию разработчику.

[[file-exists]]
=== "Файл <File> уже существует"

Предупреждение означает, что файл с названием, которое должно стать после работы программы, уже присутствует в файловой системе.
Скорее всего, скрипт повторно запущен для одного и того же файла.

Решение: Проигнорировать оповещение, поскольку это никак не влияет на работу программы для конечного пользователя.
Имя файла будет перебираться до тех пор, пока не будет найдено свободное.

[[docproperty]]
=== "DocProperty <DocProperty> не найдено в документе"

Предупреждение означает, что определенное свойство документа, которое необходимо для корректного отображения полей, не найдено или не задано.

Решение: Задать свойство вручную.
Перезапуск скрипта при этом не обязателен.

[[problems-decimal-num]]
=== Проблемы с децимальным номером

* [[invalid-decimal-num]] "Не удалось распознать децимальный номер, поэтому используется логотип ПРОТЕЙ СТ по умолчанию"
+
Предупреждение означает, что свойство документа для децимального номера не начинается с *_ПАМР_* или *_ПДРА_*, в связи с чем определить нужную компанию не удалось.
+
* [[missing-decimal-num]] "Не задан децимальный номер, поэтому используется логотип ПРОТЕЙ СТ по умолчанию"
+
Предупреждение означает, что свойство документа для децимального номера не найдено, в связи с чем определить нужную компанию не удалось.

WARNING: По умолчанию используется логотип ООО "ПРОТЕЙ СТ".

Решение: Проверить используемые в документе логотипы на титульной странице, в верхних колонтитулах для типографского формата и нижних колонтитулах для архивного формата.

Если требовались логотипы ООО "НТЦ ПРОТЕЙ", то:

. Задать свойство, DocProperty, для децимального номера;
. Перезапустить скрипт.

или

. Вручную заменить все логотипы в документе.

[[launch]]
== Запуск программы

=== Для Windows

* С помощью Проводника/Explorer перейти в директорию с файлом и запустить как любое другое приложение;
* С помощью командной строки:
. Перейти в директорию с файлом командой *_cd_*.
. Запустить скрипт командой *_.\docx_modify.exe_* или *_start docx_modify.exe_*.

NOTE: Первая команда активирует скрипт в том же окне, вторая команда открывает еще одно консольное окно.

[source,powershell]
----
$ cd .\Desktop
$ .\docx_modify.exe
$ start docx_modify.exe
----

=== Для *nix

* С помощью Проводника/Finder перейти в директорию с файлом и запустить как любое другое приложение;
* С помощью командной строки:
. Перейти в директорию с файлом командой *_cd_*.
. Запустить скрипт командой *_./docx_modify_*.

[source,console]
----
$ cd Desktop
$ ./docx_modify
----

== Техническая информация

=== Используемые библиотеки и зависимости

Астериском обозначены сторонние библиотеки, не входящие в состав базового Python и требующие отдельной установки.

==== Базовые

* colorama (+*+), только Windows
* enum
* faulthandler
* functools
* glob
* logging
* loguru (+*+)
* lxml (+*+)
* os
* pathlib
* PySide6 (+*+), только версия UI
* re
* shututil
* sys
* textwrap
* time
* tkinter, только основная версия
* tomllib
* typing
* win32-setctime (+*+), только Windows
* zipfile

==== Для разработки

* pyinstaller (+*+)
* ruff (+*+)
* uv (+*+)
* vulture (+*+)

==== Установка

[source,shell]
----
$ python3 -m venv .venv
$ source .venv/bin/activate
$ pip install uv
$ uv sync --all-groups --no-install-project
----

=== Дополнительные файлы

Все дополнительные бинарные файлы, непосредственно используемые в программе, находятся в директории `sources`.

* arch
** arch/headers_footers
** arch/rels
* change_list
* change_list_styles
* default
* image
* military
* prog
** prog/headers_footers
** prog/rels
* styles
* typo
** typo/headers_footers
** typo/rels

Файл `gui.ui` является файлом Qt Designer и представляет собой структурную схему окна UI.

.Обратная связь
****
Предложения, негодования, благодарности, проклятья можно отправлять сюда:

* Telegram: https://t.me/@andrewtar[@andrewtar];
* UC: https://uc.protei.ru[tarasov-a];
* Email: mailto:tarasov-a@protei.ru[tarasov-a@protei.ru];
* Лично: к. 513.
****
